# Pyroscope

## 介绍

* Grafana Pyroscope 是一个多租户的持续性能分析聚合系统
* 功能简介
  * 其架构设计与 Grafana Mimir、Grafana Loki 和 Grafana Tempo 保持一致
  * 它支持性能分析数据的采集、存储和查询，并与 Grafana 无缝集成，从而实现性能分析数据与现有指标、日志和跟踪数据的关联。
  * 摸清性能属性和资源需求
    * 使用 Pyroscope 的工程师能够深入了解应用程序的性能属性和资源需求。
  * 界面丰富和可视化效果
    * 凭借直观的界面和生动的数据可视化效果，Pyroscope 可以将原始性能分析数据转化为可立即执行的洞察。

### 为什么要Pyroscope

* 持续性能分析帮助团队快速识别出性能瓶颈并优化他们的应用程序
  * 生产环境/最小化额外开销/使用简单
    * 使用Grafana Pyroscope,团队可以在生产环境用最小化的额外开销简单地对他们的应用程序进行性能分析.
  * 从系统级可观测性入手，深入到可操作的代码级洞察，使团队能够识别出性能问题，无论问题发生在何处，从而能够精确地优化应用程序。


### Core functionality

* 借助 Pyroscope，您可以访问核心性能分析功能，从而查找性能瓶颈并优化应用程序。核心功能包括：
  * 极低的 CPU 开销和高效的压缩确保最佳性能。
    * 这里的极低到底有多低? 为什么会极低? 
  * 与 Loki、Mimir 和 Tempo 架构一致，带来更流畅的用户体验。
  * 水平可扩展
    * 您可以在多台机器上运行 Grafana Pyroscope。
    * 您可以轻松扩展数据库，以处理工作负载产生的分析数据量。 
  * 高可靠性
    * 高可用性设置确保持续稳定的运行时间，即使在升级或系统故障期间也是如此。
  * 多租户支持
    * 允许多个独立团队或业务部门运行同一个数据库。
  * 规模化成本效益
    * 利用对象存储，无需高昂成本即可存储大量历史数据。
    * 它兼容多种对象存储实现，包括 AWS S3、Google Cloud Storage、Azure Blob Storage、OpenStack Swift 以及任何与 S3 兼容的对象存储。
  * 高级分析用户界面
    * 提供高级用户界面、高基数标签/标记处理，以及区分标签/标记和时间间隔性能的能力。

## 什么是Profiling?

* 性能分析（Profiling）是软件开发中用于测量和分析程序运行时行为的一种技术。
  * 通过对程序进行性能分析，开发人员可以识别程序中哪些部分消耗的资源最多
    * 例如 CPU 时间、内存或 I/O 操作。
  * 您可以利用这些信息来优化程序，使其运行速度更快或资源消耗更少。
* Pyroscope 可用于传统性能分析和连续性能分析。

### 传统性能分析（非连续）

* 传统性能分析，通常被称为基于样本或基于插桩的性能分析，起源于计算机发展的早期阶段。
  * 当时，主要的挑战在于理解程序如何利用有限的计算资源。
* 在基于样本的性能分析中，性能分析器会定期中断程序，每次中断都会捕获程序的状态
  * 通过分析这些快照，开发人员可以推断出代码各部分的执行频率。
* 在基于插桩的性能分析中，开发人员会在程序中插入额外的代码来记录程序的执行信息。
  * 这种方法可以提供详细的见解，但由于增加了代码开销，可能会改变程序的行为。
* 传统性能分析提供以下优势：
  * 精准性：能够深入分析代码的特定部分。
  * 控制性：开发人员可以根据需要启动性能分析会话，从而实现有针对性的优化。
  * 详细报告：提供程序执行的细粒度数据，便于找出性能瓶颈。

## 持续Profiling

* 随着软件系统复杂性和规模的增长，传统性能分析的局限性日益凸显。
  * 在生产环境中可能会出现一些问题，而这些问题在开发或测试环境中有限的性能分析会话中却无法显现。
* 这促使了持续性能分析的出现。
  * 持续性能分析是一种在后台持续收集性能数据的方法，其开销极小。
  * 通过这种方式，开发人员可以更全面地了解程序随时间推移的行为，从而有助于识别偶发性(sporadic)或长期存在的性能问题。

* 持续性能分析提供如下的收益:
  * 持续监控
    * 与提供快照的传统方法不同，持续性能分析能够保持不间断的视图，从而揭示短期和长期的性能问题。
  * 主动瓶颈检测
    * 通过持续采集数据，可以在性能瓶颈升级之前识别并解决它们，从而减少系统停机时间并确保更流畅的运行。
  * 全面的性能概览
    * 提供跨各种平台（从不同的技术栈到不同的操作系统）的洞察，确保全面覆盖。
  * 弥合开发与生产环境的差距
    * 持续性能分析擅长突出开发环境和生产环境之间的差异：
      * 硬件差异
       * 揭示由机器规格差异引起的问题。
      * 软件不一致
        * 揭示可能影响性能的软件组件差异。
      * 真实工作负载挑战
        * 突出显示当真实用户交互和负载与开发模拟不一致时可能出现的潜在问题。
  * 经济优势
    * 资源优化
      * 持续监控确保资源不被浪费，从而节省成本。
    * 快速解决问题
      * 更快的故障排除意味着更少的耗时和资金投入，使开发人员能够将精力集中在生产性工作上。
  * 非侵入式运行
    * 持续性能分析专为后台静默运行而设计，不会影响生产环境的性能。
  * 实时响应
    * 它使团队能够立即采取行动，在问题出现时立即解决，而不是事后补救，这对于保持系统的高可用性至关重要。

### Choose between traditional and continuous profiling

在一些现代开发工作流中,两种方法都有用.

| |传统性能分析|持续性能分析|
|:-:|:-:|:-:|
|何时使用?|在开发或者测试阶段|在生产环境或长时间性能测试期间
|优势|提供详细的能指向特定部分代码的洞见|为系统性能提供一个持续的视图,通常开销更小,适合live环境|
|劣势|更高的额外开销仅提供一个时间点的快照|没有传统性能分析那么详细,因为要对正在运行中的系统最小化影响|

## 持续性能分析

* 持续性能分析是一种系统地收集和分析生产系统性能数据的方法。
* 传统上，性能分析用于按需调试应用程序。
  * 例如，您可以在本地运行基准测试工具并生成 Go 语言的 pprof 文件，
  * 或者连接到运行异常的生产实例并从 Java 的 JFR 文件中提取火焰图。
  * 这种方法适用于调试，但对于生产环境而言不够稳健。
* 持续性能分析是一种现代化的方法，它更安全、更具可扩展性，适用于生产环境。
  * 它采用低开销的采样方式从生产系统中收集性能数据，并将这些数据存储在数据库中以供后续分析。
  * 使用持续性能分析，您可以更全面地了解应用程序及其在生产环境中的运行情况。
* Grafana 提供 Grafana Pyroscope 和 Grafana Cloud Profiles（由 Pyroscope 提供支持）来收集和存储性能分析数据。
  * 您可以使用 Grafana Profiles Drilldown 来检查性能分析数据并调查问题。

### 收益

为什么要优先考虑持续性能分析？

* 深入的代码洞察
  * 它提供细粒度的、行级的代码洞察，展现应用程序代码如何利用资源，从而提供最详尽的应用程序性能视图。
* 与其他可观测性工具互补
  * 持续性能分析弥补了指标、日志和追踪等工具的关键不足，构建更全面的可观测性策略。
* 主动性能优化
  * 定期性能分析使团队能够主动识别并解决性能瓶颈，从而打造更高效、更可靠的应用程序。

### 使用场景

* 采用 Grafana Pyroscope 和 Profiles Drilldown 等工具进行持续性能分析，可以带来显著的业务优势：
  * 降低运营成本
    * 优化资源使用可以显著降低云和基础设施费用。
  * 降低延迟
    * 识别并解决性能瓶颈，可以提高应用程序的运行速度和效率。
  * 增强故障管理
    * 更快地识别和解决问题，缩短平均修复时间 (MTTR)，并改善最终用户体验。

#### 降低运营成本

通过提供对应用程序性能的深入洞察，性能分析能够帮助团队识别并消除低效环节，从而在可观测性、事件管理、消息/队列、部署工具和基础设施等领域显著节省成本。

* Pyroscope 和 Cloud Profiles 利用采样分析器，能够以极低的开销（约 2-5%，具体取决于一些因素）收集数据。
* 定制的存储引擎能够高效地压缩和存储数据。
* 其优势包括：
  * 得益于采样分析器技术，CPU 开销极低
  * 可控制分析数据的粒度（从数十秒到数年不等）
  * 高效压缩，磁盘空间占用和成本都很低

#### 降低延迟

* 性能分析在降低应用程序延迟方面发挥着关键作用，它能够识别代码层面的性能瓶颈。
* 这种细致入微的洞察可以实现针对性优化，从而加快应用程序响应速度，改善用户体验，并最终带来更好的业务成果，例如提高客户满意度和收入。

#### 增强事件管理

* Pyroscope 和 Profiles Drilldown 通过提供关于应用程序性能问题的即时、可操作的洞察，简化了事件管理。
* 借助持续的性能分析，团队可以快速定位事件的根本原因，从而缩短平均修复时间 (MTTR)，并提高整体系统可靠性和用户满意度。

## Profiling类型以及他们的用途

* 性能分析是理解和优化应用程序性能的重要工具。
* 在 Grafana Pyroscope 中，多种性能分析类型允许您对应用程序的各个方面进行深入分析。

### Profiling类型

* 分析类型指的是应用程序性能分析的不同维度，侧重于 CPU 使用率、内存分配或线程同步等特定方面。
* Pyroscope 支持以下分析类型：
  * CPU（CPU 时间、实际运行时间）
  * 内存（分配对象、分配空间、堆）
  * 使用中的对象和使用中的空间
  * Goroutine（Goroutine 会话）
  * 互斥锁计数和持续时间
  * 代码块计数和持续时间
  * 锁计数和持续时间
  * 异常

有关基于插桩方法的支持分析类型的信息，请参阅“分析类型”表。

有关自动插桩和支持的语言 SDK 的信息，请参阅“配置客户端”。


## 火焰图

## Profiling 和 Tracing

## Pyroscope and Profiling in Grafana

